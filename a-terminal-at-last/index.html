<!DOCTYPE html>
<html>
  <head>
    <title>A terminal, at last – SnowflakeOS's blog</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
Let’s face it, it’s hard to get excited about a kernel from just barebone demos of barely functional systems. In this article, I propose a radical solution: actually implementing useful userspace programs, namely a terminal, and ye old copycat of paint.

" />
    <meta property="og:description" content="
Let’s face it, it’s hard to get excited about a kernel from just barebone demos of barely functional systems. In this article, I propose a radical solution: actually implementing useful userspace programs, namely a terminal, and ye old copycat of paint.

" />
    
    <meta name="author" content="jmnl.xyz" />

    
    <meta property="og:title" content="A terminal, at last" />
    <meta property="twitter:title" content="A terminal, at last" />
    
    
    <meta property="og:image" content="/assets/sos-paint.jpg" />
    


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="jmnl.xyz - Locally grown blog posts" href="/feed.xml" />
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-169883671-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-169883671-1');
</script>


  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/assets/logo_big.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">jmnl.xyz</a></h1>
            <p class="site-description">Locally grown blog posts</p>
          </div>

          <nav>
            <a href="/">SnowflakeOS</a>
            <a href="/hiking">Hiking</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>A terminal, at last</h1>

  <div class="entry">
    <p><img src="/assets/sos-paint.jpg" alt="picture" class="thumbnail" title="The author wasn't fucking around _this_ week." />
Let’s face it, it’s hard to get excited about a kernel from just barebone demos of barely functional systems. In this article, I propose a radical solution: actually implementing useful userspace programs, namely a terminal, and ye old copycat of paint.</p>

<p>But wait, you scream, last time you didn’t have moving windows, a mouse pointer, or the ability to get input from userspace, how come now we’re implementing a terminal?<br />
Right, right, let’s get it over with.</p>

<h2 id="communicating-with-the-wm">Communicating with the wm</h2>

<p>If you recall <a href="/of-mice-and-keyboards/">this post</a>, our keyboard and mouse drivers were in pretty fine shape, useless though they were then. We’ll use them right away to register callbacks, set to fire when a key is pressed, or released, and when something happens to the mouse:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init_wm</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">...;</span>
    <span class="n">mouse_set_callback</span><span class="p">(</span><span class="n">wm_mouse_callback</span><span class="p">);</span>
    <span class="n">kbd_set_callback</span><span class="p">(</span><span class="n">wm_kbd_callback</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s talk about how we handle mouse events first. We want clicks to push windows to the front, we want mouse drags to move windows, and we want some of these events to reach the affected window. I say some, because of a choice made in the wm: windows can be dragged from anywhere in their rectangle, and they can’t opt out. Therefore there can’t be drag events within windows, the cursor doesn’t move relative to the dragged window anyway.<br />
All of that takes some code, about ninety lines total. It ain’t thrilling, so I won’t force it upon your eyes, dear reader, but it’s <a href="https://github.com/29jm/SnowflakeOS/blob/1dd718af791f4fd869e94f6ecbc9b98d1a3f6c9c/kernel/src/misc/wm/wm.c#L407-L501">right here</a> if needed.</p>

<p>A point more worthy of being highlighted is how exactly the wm tells a window “you’ve been clicked here”, or “the mouse moved from here to there”. In most (all?) other OS, the wm is in userspace and uses IPC and some bespoke protocol to speak with its clients.<br />
In SnowflakeOS, clients poll the wm using a system call, <code class="language-plaintext highlighter-rouge">snow_get_event</code>, which is really a call to <code class="language-plaintext highlighter-rouge">syscall2(SYS_WM, WM_CMD_EVENT, wm_event_t* event)</code><sup class="tooltip">[<a href="https://github.com/29jm/SnowflakeOS/blob/1dd718af791f4fd869e94f6ecbc9b98d1a3f6c9c/snow/src/gui.c#L80-L91">1</a>]<span>all wm commands go through the SYS_WM syscall</span></sup>. The structure returned, <code class="language-plaintext highlighter-rouge">wm_event_t</code>, is a copy of the kernel-side, per-window <code class="language-plaintext highlighter-rouge">wm_event_t</code> object, and contains approximately the following fields:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">;</span> <span class="c1">// describes valid fields</span>
    <span class="n">wm_mouse_event_t</span> <span class="n">mouse</span><span class="p">;</span>
    <span class="n">wm_kbd_event_t</span> <span class="n">kbd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">wm_event_t</span><span class="p">;</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">mouse</code> and <code class="language-plaintext highlighter-rouge">kbd</code> are defined in somewhat obvious ways in <a href="https://github.com/29jm/SnowflakeOS/blob/1dd718af791f4fd869e94f6ecbc9b98d1a3f6c9c/kernel/include/kernel/uapi/uapi_wm.h">uapi_wm.h</a><sup class="tooltip">[2]<span>thanks to Protura’s dev for suggesting this way of sharing kernel headers!</span></sup>. So, clients poll the wm for this structure, and that’s the client side of it. The kernel, wm side of it is pretty straightforward: the mouse and keyboard callbacks fill <code class="language-plaintext highlighter-rouge">mask</code> and other fields as needed, for instance in the keyboard handler:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">wm_kbd_callback</span><span class="p">(</span><span class="n">kbd_event_t</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">windows</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wm_window_t</span><span class="o">*</span> <span class="n">win</span> <span class="o">=</span> <span class="n">list_last</span><span class="p">(</span><span class="n">windows</span><span class="p">);</span>

        <span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">WM_EVENT_KBD</span><span class="p">;</span>
        <span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">kbd</span><span class="p">.</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">keycode</span><span class="p">;</span>
        <span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">kbd</span><span class="p">.</span><span class="n">pressed</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">pressed</span><span class="p">;</span>
        <span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">kbd</span><span class="p">.</span><span class="n">repr</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">repr</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and events are cleared once they’ve been queried:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">wm_get_event</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">win_id</span><span class="p">,</span> <span class="n">wm_event_t</span><span class="o">*</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wm_window_t</span><span class="o">*</span> <span class="n">win</span> <span class="o">=</span> <span class="n">wm_get_window</span><span class="p">(</span><span class="n">win_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wm_event_t</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I’m sure some of you are wondering where event queues fit in there. I’ve heard of them, but I don’t practice<sup class="tooltip">[3]<span>I’ll make a queue in the keyboard driver for sure</span></sup>. What do I do if two keys are pressed, and the event structure hasn’t been retrieved in between? I drop a keypress.</p>

<p>Just take your time when writing stuff, it’s the zen of SnowflakeOS.</p>

<h2 id="a-terminal">A terminal</h2>

<figure>
    <img src="/assets/terminal.png" />
    <figcaption>The classic, the irreplaceable.</figcaption>
</figure>

<p>Here’s something I haven’t done in a long time, if ever: writing C apps. There’s a very real difference between kernel code and application code, I think. And I suck at writing actual C programs. C feels much less friendly to me in this space, I guess in large part because I don’t know what I’m doing. For instance I’ve felt the need to make my own string object and related functions. C’s basic string handling functions are notoriously terrible though, I’m surprised it’s the first time I felt the need to replace them.</p>

<p>Anyway, what does a terminal do? Usually, it runs a single program, the shell, and it handles printing its output nice and tidy, which includes handling escape sequences (we had those, <a href="https://github.com/29jm/SnowflakeOS/commit/1e1c45656152f428ebfdc0b919bd08a1074580b0">a long time ago</a>), line wrapping, sometimes mouse handling I guess. I actually don’t known much more than that. SnowflakeOS has an <code class="language-plaintext highlighter-rouge">exec</code> system call<sup class="tooltip">[<a href="https://github.com/29jm/SnowflakeOS/commit/6444c76b939975f91c96133118b1ea7dd58ecfe3">4</a>]<span>this is new too! not much work. this one is an actual link btw.</span></sup>, but no concept of child process, forks, etc… so we can’t have that traditional terminal-shell separation just yet. For the same reason, external processes won’t be able to print to the terminal, only builtin commands. Well <em>whatever</em><sup class="tooltip">[5]<span>though this will be fixed</span></sup>, we just want a fancy way to start paint ;)</p>

<p>The terminal follows the same basic structure of every graphical app ever: handle input, redraw, loop. Let’s take a look at input handling:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wm_event_t</span> <span class="n">event</span> <span class="o">=</span> <span class="n">snow_get_event</span><span class="p">(</span><span class="n">win</span><span class="p">);</span>
    <span class="p">...;</span>
    <span class="c1">// Skip kbd handling &amp; redrawing in this case</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">key_pressed</span> <span class="o">||</span> <span class="n">focus_changed</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">kbd</span><span class="p">.</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">KBD_ENTER</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">KBD_KP_ENTER</span><span class="p">:</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">interpret_cmd</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">input_buf</span><span class="p">);</span>
            <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
            <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">KBD_BACKSPACE</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
                <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">keycode</span> <span class="o">&lt;</span> <span class="n">KBD_KP_ENTER</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\0\0</span><span class="s">"</span><span class="p">;</span>
                <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">repr</span><span class="p">;</span>
                <span class="n">str_append</span><span class="p">(</span><span class="n">input_buf</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That’s pretty ugly switch, let me explain. I chose to have two text buffers to represent the text displayed on the terminal. One, <code class="language-plaintext highlighter-rouge">input_buf</code>, contains the current line of user input, and it can be edited, and the other, <code class="language-plaintext highlighter-rouge">text_buf</code>, contains all the rest. It makes sense then that pressing enter would append the input to the static buffer, interpret that input, and clear it. Currently the terminal handles editing through backspace, no arrow keys yet. Other keys aren’t special (we just require they be printable), and are just appended to the input buffer.<br />
My <code class="language-plaintext highlighter-rouge">str_t</code> type makes things a bit ugly there, I haven’t taken the time to make enough utility functions. It’s useful because  <code class="language-plaintext highlighter-rouge">str_t</code> has no length limit as <code class="language-plaintext highlighter-rouge">str_append</code> reallocates if needed, which happens when <code class="language-plaintext highlighter-rouge">text_buf</code> grows.</p>

<p>The next step is to interpret the input we got, which is done here:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">interpret_cmd</span><span class="p">(</span><span class="n">str_t</span><span class="o">*</span> <span class="n">text_buf</span><span class="p">,</span> <span class="n">str_t</span><span class="o">*</span> <span class="n">input_buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"uname"</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"SnowflakeOS 0.5</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"ls"</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"No."</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"dmesg"</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">klog</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
        <span class="n">sys_info_t</span> <span class="n">info</span><span class="p">;</span>
        <span class="n">info</span><span class="p">.</span><span class="n">kernel_log</span> <span class="o">=</span> <span class="n">klog</span><span class="p">;</span>
        <span class="n">syscall2</span><span class="p">(</span><span class="n">SYS_INFO</span><span class="p">,</span> <span class="n">SYS_INFO_LOG</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
        <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">klog</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"exit"</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">int32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">syscall1</span><span class="p">(</span><span class="n">SYS_EXEC</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"invalid command: "</span><span class="p">);</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
            <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Spot the funky <code class="language-plaintext highlighter-rouge">dmesg</code> here! The API to get the kernel log is dreadful, but now I can actually debug things from within QEMU:</p>

<p><img src="/assets/dmesg.jpg" alt="isn't it glorious" title="the calc is a lie" /></p>

<p>Finally, we get to redrawing the terminal. We have the tools to draw text, we have the text, let’s do this.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">redraw</span><span class="p">(</span><span class="n">str_t</span><span class="o">*</span> <span class="n">text_buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">str_t</span><span class="o">*</span> <span class="n">input_buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Title bar, background... */</span>
    <span class="p">...;</span>

    <span class="cm">/* Text content */</span>

    <span class="c1">// Temporarily concatenate the input and a cursor</span>
    <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">str_append</span><span class="p">(</span><span class="n">text_buf</span><span class="p">,</span> <span class="s">"_"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">text_view</span> <span class="o">=</span> <span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">line_buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">max_col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">n_lines</span> <span class="o">=</span> <span class="n">count_lines</span><span class="p">(</span><span class="n">text_buf</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="c1">// below the title bar</span>

    <span class="c1">// Scroll the view as needed</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_lines</span> <span class="o">&gt;</span> <span class="n">max_line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_lines</span> <span class="o">-</span> <span class="n">max_line</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">text_view</span> <span class="o">=</span> <span class="n">scroll_view</span><span class="p">(</span><span class="n">text_view</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Draw line by line, wrapping text</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">text_view</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">])</span> <span class="p">{</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">lf</span> <span class="o">=</span> <span class="n">strchrnul</span><span class="p">(</span><span class="n">text_view</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">);</span>
        <span class="kt">uint32_t</span> <span class="n">line_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">lf</span> <span class="o">-</span> <span class="n">text_view</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">line_len</span> <span class="o">&lt;=</span> <span class="n">max_col</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">strncpy</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span> <span class="n">text_view</span><span class="p">,</span> <span class="n">line_len</span><span class="p">);</span>
            <span class="n">line_buf</span><span class="p">[</span><span class="n">line_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
            <span class="n">text_view</span> <span class="o">+=</span> <span class="n">line_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// +1 discards linefeed</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">strncpy</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span> <span class="n">text_view</span><span class="p">,</span> <span class="n">max_col</span><span class="p">);</span>
            <span class="n">line_buf</span><span class="p">[</span><span class="n">max_col</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
            <span class="n">text_view</span> <span class="o">+=</span> <span class="n">max_col</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">snow_draw_string</span><span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text_color</span><span class="p">);</span>

        <span class="n">y</span> <span class="o">+=</span> <span class="n">char_height</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// De-concatenate the input</span>
    <span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">input_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
        <span class="n">text_buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Update the window</span>
    <span class="n">snow_render_window</span><span class="p">(</span><span class="n">win</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s break it down. First, we make sure to work with only one text buffer by merging the input with the static text, we don’t care to distinguish those here. We even include a blinking cursor for sanity reasons. Then, we make sure to draw the “bottom” of the buffer by scrolling if needed. If what this means is unclear, try spamming commands in a newly opened terminal, it’ll scroll the view when you reach the bottom. Finally, we draw the text line by line, keeping in mind that a line either ends with a line feed, or by reaching the right side of the window.<br />
If you’re like me and didn’t know about it, <code class="language-plaintext highlighter-rouge">strchrnul</code> returns the the address of the trailing null byte in a string if nothing matches the query, instead of returning <code class="language-plaintext highlighter-rouge">NULL</code> like the classic <code class="language-plaintext highlighter-rouge">strchr</code> would.</p>

<p>All in all, we now have a working terminal.</p>

<h2 id="paint">Paint</h2>

<figure>
    <img src="/assets/paint.png" />
    <figcaption>"Snowflakistan". I blame my mouse driver.</figcaption>
</figure>

<p>Kernel development is an art, or so some think. I enjoy consensus and wanted to address the concerns of naysayers, and with that goal in mind set out to make my kernel art-able. What program then could be better suited to artistic expression than the humble paint?</p>

<p>The code here has even fewer bells and whistles than the terminal, and I won’t dare bore you with it. Get input, if click, toggle drawing, if mouse move and drawing, draw a line, loop. Note that because of window dragging mechanics you can’t keep pressing the mouse to draw, you have to release it. I think it’s not totally senseless UX-wise<sup class="tooltip">[6]<span>it mostly is though, yes</span></sup>, as you’re free to focus only on the movement of your hand.</p>

<p>But, but, but, the five cool, old-school buttons on the top left are of some interest. I’ve started making a GUI toolkit, and what you’re really seeing here are three color picker buttons and two normal buttons in a horizontal layout. This code is really a work in progress by any measure, but working on it has been pretty interesting so far. I’m taking a GTK-like approach, because it’s the only C GUI toolkit I’ve ever touched. Thankfully I barely remember any of it, so I’m free to make the same mistakes it did, but also new and cooler ones.</p>

<p>In our paint version, this toolkit is used in a very hackish way, but it gives a general idea of how things will look:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Setup the UI */</span>
<span class="n">hbox_t</span><span class="o">*</span> <span class="n">picker</span> <span class="o">=</span> <span class="n">hbox_new</span><span class="p">();</span>
<span class="c1">// No parent/root widget, so we position it manually</span>
<span class="n">picker</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">fb_x</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">picker</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">fb_y</span><span class="p">;</span>

<span class="c1">// `color` is defined earlier</span>
<span class="n">hbox_add</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="p">(</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">color_button_new</span><span class="p">(</span><span class="mh">0x000000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">));</span>
<span class="n">hbox_add</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="p">(</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">color_button_new</span><span class="p">(</span><span class="mh">0x513CBC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">));</span>
<span class="n">hbox_add</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="p">(</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">color_button_new</span><span class="p">(</span><span class="mh">0xFC0A5A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">));</span>

<span class="n">button_t</span><span class="o">*</span> <span class="n">exit_button</span> <span class="o">=</span> <span class="n">button_new</span><span class="p">(</span><span class="s">"exit"</span><span class="p">);</span>
<span class="n">exit_button</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">on_click</span> <span class="o">=</span> <span class="p">(</span><span class="n">widget_clicked_t</span><span class="p">)</span> <span class="n">on_exit_clicked</span><span class="p">;</span>
<span class="n">hbox_add</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="p">(</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">exit_button</span><span class="p">);</span>

<span class="n">button_t</span><span class="o">*</span> <span class="n">clear_button</span> <span class="o">=</span> <span class="n">button_new</span><span class="p">(</span><span class="s">"clear"</span><span class="p">);</span>
<span class="n">clear_button</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">on_click</span> <span class="o">=</span> <span class="p">(</span><span class="n">widget_clicked_t</span><span class="p">)</span> <span class="n">on_clear_clicked</span><span class="p">;</span>
<span class="n">hbox_add</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="p">(</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">clear_button</span><span class="p">);</span>

<span class="p">...;</span> <span class="c1">// Later, in the program loop</span>

<span class="cm">/* Give these lads some input */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">point_in_rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">picker</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">bounds</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">picker</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">.</span><span class="n">on_click</span><span class="p">((</span><span class="n">widget_t</span><span class="o">*</span><span class="p">)</span> <span class="n">picker</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Anyway, you can paint stuff now. It’s plenty fast in QEMU, but that could still be easily improved: right now we tell the wm to update the whole window rect<sup class="tooltip">[7]<span>clipping rules still apply in wm land, of course</span></sup>, when we could tell it to update only the small square containing the new line we just drew. Another big improvement, and not just to paint, would be to store the mouse’s position as a pair of floats instead of ints, because right now small movements are basically ignored due to rounding errors in the wm’s code. One advantage is that it’s really easy to draw squares right now, but unless a sizeable fraction of users turns out to be rabbid fans of the <a href="https://en.wikipedia.org/wiki/Suprematism">Suprematist</a> movement, I think it’s worth fixing.</p>

<hr />

<p>On a final note, I wanted to thank /r/osdev’s users for sharing their progress, in particular skiftOS’s developer, whose beautiful UI and OS reminded me to try a little harder, because the results are clearly worth it.</p>


  </div>

  <div class="date">
    Written on May 24, 2020
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/29jm"><i class="svg-icon github"></i></a>



<a href="/feed.xml"><i class="svg-icon rss"></i></a>




        </footer>
      </div>
    </div>

  </body>
</html>
